<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Controle Financeiro - Firebase v1</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f8fafc; padding-bottom: 80px; }
    .card { background:#fff;border-radius:10px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,0.05);margin-bottom:14px; }
    .fab { position:fixed; right:20px; bottom:20px; background:#f59e0b; /* Cor Laranja para diferenciar que Ã© Firebase */ color:#fff; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:32px; cursor:pointer; box-shadow:0 4px 15px rgba(245,158,11,0.3); z-index: 50; transition: transform 0.1s; }
    .fab:active { transform: scale(0.95); }
    .hidden { display:none; }
    table { width:100%; border-collapse:collapse; min-width: 600px; }
    th, td { padding:12px 8px; border-bottom:1px solid #f1f5f9; text-align:left; font-size: 14px; }
    .muted { color:#6b7280; }
    .btn { padding:10px 16px; border-radius:8px; background:#f59e0b; /* Laranja */ color:#fff; border:none; cursor:pointer; font-size: 14px; white-space: nowrap; }
    .btn.secondary { background:#6b7280; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; }
    input[type="month"], select, input, textarea { padding:10px; border-radius:6px; border:1px solid #e5e7eb; width: 100%; }
    .font-bold { font-weight: 700; }
    .text-green { color: #16a34a; }
    .text-red { color: #dc2626; }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-4 md:p-6">
    
    <header class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
      <div>
        <h1 class="text-xl md:text-2xl font-bold text-gray-800">FinanÃ§as Firebase ðŸ”¥</h1>
        <p class="text-xs md:text-sm muted">Sistema conectado ao Google Firebase</p>
      </div>
      
      <div class="flex flex-col md:flex-row items-stretch md:items-center gap-2 w-full md:w-auto">
        <div class="flex gap-2">
            <button id="btn-refresh-all" class="btn secondary flex-1">Atualizar</button>
            <button id="btn-logout" class="btn secondary flex-1 hidden">Sair</button>
        </div>
        <div id="auth-area" class="card p-3" style="margin-bottom:0; min-width:280px;">
            <div id="login-form" class="flex flex-col gap-2">
                <input id="email" placeholder="E-mail" />
                <input id="password" type="password" placeholder="Senha" />
                <div class="flex gap-2">
                    <button id="btn-login" class="btn flex-1">Entrar</button>
                    <button id="btn-signup" class="btn secondary flex-1">Criar Conta</button>
                </div>
                <div id="auth-msg" class="text-xs text-center text-red-500"></div>
            </div>
            <div id="user-info" class="hidden">
                <div class="text-xs muted">Logado como:</div>
                <div id="user-email" class="font-bold text-sm">...</div>
            </div>
        </div>
      </div>
    </header>

    <div id="app-content" class="hidden">
        <nav class="mb-4 overflow-x-auto pb-2">
        <div class="flex gap-2 whitespace-nowrap">
            <button class="tab-btn btn active" data-tab="dashboard">Dashboard</button>
            <button class="tab-btn btn secondary" data-tab="transacoes">TransaÃ§Ãµes</button>
            <button class="tab-btn btn secondary" data-tab="futuras">Futuras</button>
            <button class="tab-btn btn secondary" data-tab="extrato">Extrato</button>
        </div>
        </nav>

        <main>
        <section id="dashboard" class="card">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4 gap-3">
            <div class="flex items-center gap-3 w-full md:w-auto">
                <label class="small muted whitespace-nowrap">MÃªs:</label>
                <input id="dash-month" type="month" class="border p-2 rounded w-full" />
            </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mb-3">
            <div class="card mb-0"><div class="text-xs muted uppercase">Total Receitas</div><div id="total-receitas-mes" class="text-2xl font-bold text-green">R$ 0,00</div></div>
            <div class="card mb-0"><div class="text-xs muted uppercase">Total Despesas</div><div id="total-despesas-mes" class="text-2xl font-bold text-red">R$ 0,00</div></div>
            <div class="card mb-0"><div class="text-xs muted uppercase">Saldo LÃ­quido</div><div id="saldo-mes" class="text-2xl font-bold">R$ 0,00</div></div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
            <div class="card mb-0"><div class="text-xs muted uppercase">Receitas Previstas</div><div id="receitas-previstas" class="text-xl font-bold text-green">R$ 0,00</div></div>
            <div class="card mb-0"><div class="text-xs muted uppercase">Contas a Pagar</div><div id="contas-a-pagar" class="text-xl font-bold text-red">R$ 0,00</div></div>
            <div class="card mb-0"><div class="text-xs muted uppercase">PrevisÃ£o Futura</div><div id="previsao-futura" class="text-xl font-bold">R$ 0,00</div></div>
            </div>
        </section>

        <section id="transacoes" class="card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-4 gap-3">
            <div class="grid grid-cols-2 md:flex gap-2 w-full md:w-auto">
                <div><label class="text-xs muted">MÃªs</label><input id="trans-month" type="month" /></div>
                <div><label class="text-xs muted">Tipo</label><select id="trans-type"><option value="todos">Todos</option><option value="entrada">Receitas</option><option value="saida">DÃ­vidas</option></select></div>
            </div>
            <div class="w-full md:w-auto"><label class="text-xs muted">Buscar</label><input id="trans-search" placeholder="Buscar..." /></div>
            <div class="w-full md:w-auto"><button id="btn-refresh" class="btn w-full md:w-auto">Atualizar</button></div>
            </div>
            <div class="overflow-x-auto pb-2">
            <table>
                <thead><tr><th>Data</th><th>DescriÃ§Ã£o</th><th>Categoria</th><th>Tipo</th><th class="text-right">Valor</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead>
                <tbody id="trans-tbody"><tr><td colspan="7" class="text-center muted py-8">Carregando...</td></tr></tbody>
            </table>
            </div>
        </section>

        <section id="futuras" class="card hidden">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-3">
            <div class="w-full md:w-auto"><label class="text-xs muted">MÃªs</label><input id="futuras-month" type="month" /></div>
            <div class="w-full md:w-auto"><button id="btn-refresh-fut" class="btn w-full">Atualizar</button></div>
            </div>
            <div class="overflow-x-auto pb-2">
            <table>
                <thead><tr><th>Data</th><th>DescriÃ§Ã£o</th><th>Categoria</th><th>Tipo</th><th class="text-right">Valor</th><th>AÃ§Ãµes</th></tr></thead>
                <tbody id="futuras-tbody"><tr><td colspan="6" class="text-center muted py-8">Sem dados</td></tr></tbody>
            </table>
            </div>
        </section>

        <section id="extrato" class="card hidden">
            <div class="flex flex-col md:flex-row gap-4 items-end mb-4">
            <div class="w-full md:w-auto"><label class="text-xs muted">MÃªs</label><input id="extrato-month" type="month" /></div>
            <div class="flex gap-2 w-full md:w-auto"><button id="btn-generate-pdf" class="btn flex-1">PDF</button><button id="btn-generate-csv" class="btn secondary flex-1">CSV</button></div>
            </div>
            <div id="extrato-preview" class="card overflow-x-auto"><div class="small muted mb-2">PrÃ©-visualizaÃ§Ã£o</div><div id="extrato-list">Nenhum dado</div></div>
        </section>
        </main>
        <div class="fab" id="fab-add" title="Adicionar">+</div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-end md:items-center justify-center p-0 md:p-4">
      <div class="bg-white w-full md:max-w-lg md:rounded-lg rounded-t-2xl p-6 animate-slide-up">
        <h3 class="text-lg font-bold mb-4 text-gray-800">Novo lanÃ§amento</h3>
        <form id="form">
          <input type="hidden" id="tx-id" />
          <div class="grid grid-cols-1 gap-3">
            <input id="field-valor" required placeholder="Valor (ex: 150,50)" class="text-lg font-bold" />
            <div class="grid grid-cols-2 gap-2">
                <select id="field-tipo"><option value="entrada">Receita</option><option value="saida">DÃ­vida</option></select>
                <input id="field-data" type="date" required />
            </div>
            <input id="field-categoria" placeholder="Categoria" />
            <textarea id="field-desc" placeholder="DescriÃ§Ã£o" rows="2"></textarea>
            <div class="grid grid-cols-2 gap-2">
                <div><label class="text-xs muted">Status</label><select id="field-status"><option value="pendente">Pendente</option><option value="efetivado" selected>Efetivado</option></select></div>
                <div><label class="text-xs muted">RecorrÃªncia</label><select id="field-recurrence"><option value="none">NÃ£o</option><option value="parcel">Parcelar</option><option value="fixed_monthly">Fixa Mensal</option></select></div>
            </div>
            <div id="recurrence-details" class="hidden bg-gray-50 p-3 rounded">
              <div class="grid grid-cols-2 gap-2">
                <input id="recurrence-count" type="number" min="2" placeholder="Qtd" />
                <select id="recurrence-interval"><option value="monthly">Mensal</option><option value="weekly">Semanal</option></select>
              </div>
            </div>
            <div class="flex justify-end gap-3 mt-2">
              <button type="button" id="btn-cancel" class="btn secondary w-full">Cancelar</button>
              <button type="submit" id="btn-save" class="btn w-full">Salvar</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

<script type="module">
// --- IMPORTAÃ‡Ã•ES FIREBASE (MODERNAS) ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// --- SUA CONFIGURAÃ‡ÃƒO (Copiada do Print) ---
const firebaseConfig = {
  apiKey: "AIzaSyC5aGRF1qU1rhfi7jhZywy5NNaPr6lJfvo",
  authDomain: "controlefinanceirov1-c2b59.firebaseapp.com",
  projectId: "controlefinanceirov1-c2b59",
  storageBucket: "controlefinanceirov1-c2b59.firebasestorage.app",
  messagingSenderId: "28738888590",
  appId: "1:28738888590:web:ddfca08150f981fb163adf"
};

// INICIALIZAÃ‡ÃƒO
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// VARIÃVEIS GLOBAIS
let currentUser = null;
let transactions = [];

// ELEMENTOS DOM
const appContent = document.getElementById('app-content');
const loginForm = document.getElementById('login-form');
const userInfo = document.getElementById('user-info');
const userEmailDisplay = document.getElementById('user-email');
const btnLogin = document.getElementById('btn-login');
const btnSignup = document.getElementById('btn-signup');
const btnLogout = document.getElementById('btn-logout');
const authMsg = document.getElementById('auth-msg');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');

// --- AUTENTICAÃ‡ÃƒO (FIREBASE) ---
onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        loginForm.classList.add('hidden');
        userInfo.classList.remove('hidden');
        userEmailDisplay.textContent = user.email;
        btnLogout.classList.remove('hidden');
        appContent.classList.remove('hidden');
        initData();
    } else {
        currentUser = null;
        loginForm.classList.remove('hidden');
        userInfo.classList.add('hidden');
        btnLogout.classList.add('hidden');
        appContent.classList.add('hidden');
        transactions = [];
    }
});

// BotÃµes de Login
btnLogin.onclick = async () => {
    try {
        await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        authMsg.textContent = "";
    } catch (e) { authMsg.textContent = "Erro ao entrar: " + e.message; }
};

btnSignup.onclick = async () => {
    try {
        await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        authMsg.textContent = "";
    } catch (e) { authMsg.textContent = "Erro ao criar: " + e.message; }
};

btnLogout.onclick = async () => { await signOut(auth); };

// --- LÃ“GICA DO SISTEMA (ADAPTADA PARA FIREBASE) ---

// Fetch
async function fetchTransactions() {
    if(!currentUser) return;
    // Consulta no Firestore: ColeÃ§Ã£o 'transactions', onde user_id == id do usuÃ¡rio, ordenado por data
    // Nota: Firestore precisa de Ã­ndice para orderBy complexo, vamos simplificar pegando tudo e ordenando no JS por enquanto
    const q = query(collection(db, "transactions"), where("user_id", "==", currentUser.uid));
    const querySnapshot = await getDocs(q);
    
    transactions = [];
    querySnapshot.forEach((doc) => {
        transactions.push({ id: doc.id, ...doc.data() });
    });
    // OrdenaÃ§Ã£o no cliente para evitar erro de Ã­ndice do Firestore no inÃ­cio
    transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
    return transactions;
}

// Salvar (Adicionar ou Editar)
document.getElementById('form').onsubmit = async (e) => {
    e.preventDefault();
    if(!currentUser) return;
    
    const id = document.getElementById('tx-id').value;
    const valStr = document.getElementById('field-valor').value.replace(/\D/g,'');
    const amount = valStr ? Number(valStr)/100 : 0;
    
    const data = {
        user_id: currentUser.uid,
        amount: amount,
        type: document.getElementById('field-tipo').value,
        date: document.getElementById('field-data').value,
        category: document.getElementById('field-categoria').value,
        description: document.getElementById('field-desc').value,
        status: document.getElementById('field-status').value,
        recurrence: document.getElementById('field-recurrence').value
    };

    try {
        if(id) {
            // Editar
            await updateDoc(doc(db, "transactions", id), data);
        } else {
            // Adicionar
            await addDoc(collection(db, "transactions"), data);
        }
        document.getElementById('modal').classList.add('hidden');
        await fetchTransactions();
        renderAll();
        alert("Salvo com sucesso!");
    } catch (e) {
        alert("Erro ao salvar: " + e.message);
        console.error(e);
    }
};

// Excluir
async function deleteTx(id) {
    if(!confirm("Excluir?")) return;
    try {
        await deleteDoc(doc(db, "transactions", id));
        await fetchTransactions();
        renderAll();
    } catch(e) { alert("Erro ao excluir"); }
}

// RenderizaÃ§Ã£o (Igual Ã  v13, mas adaptada para chamar deleteTx)
function renderAll() {
    renderDashboard();
    renderTable();
}

function fmt(v) { return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function formatDate(d) { if(!d) return ''; const p=d.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }

function renderDashboard() {
    const m = document.getElementById('dash-month').value;
    const txs = transactions.filter(t => t.date.startsWith(m));
    
    const rec = txs.filter(t=>t.type==='entrada' && t.status==='efetivado').reduce((s,i)=>s+i.amount,0);
    const desp = txs.filter(t=>t.type==='saida' && t.status==='efetivado').reduce((s,i)=>s+i.amount,0);
    
    document.getElementById('total-receitas-mes').textContent = fmt(rec);
    document.getElementById('total-despesas-mes').textContent = fmt(desp);
    document.getElementById('saldo-mes').textContent = fmt(rec - desp);
    
    const prev = transactions.filter(t=>t.status==='pendente' && t.type==='entrada').reduce((s,i)=>s+i.amount,0);
    document.getElementById('receitas-previstas').textContent = fmt(prev);
    
    const pagar = transactions.filter(t=>t.status==='pendente' && t.type==='saida').reduce((s,i)=>s+i.amount,0);
    document.getElementById('contas-a-pagar').textContent = fmt(pagar);
}

function renderTable() {
    const m = document.getElementById('trans-month').value;
    const tbody = document.getElementById('trans-tbody');
    tbody.innerHTML = '';
    
    const txs = transactions.filter(t => t.date.startsWith(m));
    
    if(txs.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="text-center muted">Nada aqui.</td></tr>'; return; }

    txs.forEach(t => {
        const tr = document.createElement('tr');
        const color = t.type === 'entrada' ? 'text-green' : 'text-red';
        const sign = t.type === 'entrada' ? '+' : '-';
        
        tr.innerHTML = `
            <td>${formatDate(t.date)}</td>
            <td>${t.description}</td>
            <td>${t.category}</td>
            <td>${t.type}</td>
            <td class="text-right font-bold ${color}">${sign} ${fmt(t.amount)}</td>
            <td>${t.status}</td>
            <td>
                <button class="btn-edit btn" data-id="${t.id}">Editar</button>
                <button class="btn-del btn secondary" data-id="${t.id}">Excluir</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    // Event Listeners para botÃµes dinÃ¢micos
    document.querySelectorAll('.btn-del').forEach(b => b.onclick = () => deleteTx(b.dataset.id));
    document.querySelectorAll('.btn-edit').forEach(b => b.onclick = () => openEdit(b.dataset.id));
}

// Helpers de UI
function openEdit(id){
    const t = transactions.find(x=>x.id===id);
    if(!t) return;
    document.getElementById('tx-id').value = id;
    document.getElementById('field-valor').value = fmt(t.amount);
    document.getElementById('field-tipo').value = t.type;
    document.getElementById('field-data').value = t.date;
    document.getElementById('field-desc').value = t.description;
    document.getElementById('field-status').value = t.status;
    document.getElementById('modal').classList.remove('hidden');
}

// MÃ¡scara de moeda
const fVal = document.getElementById('field-valor');
fVal.addEventListener('input', (e)=>{
    let v = e.target.value.replace(/\D/g,'');
    if(!v) return;
    e.target.value = (parseInt(v)/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
});

// Datas Iniciais
const today = new Date().toISOString().split('T')[0];
const ym = today.slice(0,7);
['dash-month','trans-month','futuras-month','extrato-month'].forEach(id => document.getElementById(id).value = ym);

// Inicializar
async function initData() {
    await fetchTransactions();
    renderAll();
}

// BotÃµes globais
document.getElementById('btn-refresh').onclick = initData;
document.getElementById('btn-refresh-all').onclick = initData;
document.getElementById('fab-add').onclick = () => {
    document.getElementById('form').reset();
    document.getElementById('tx-id').value = '';
    document.getElementById('modal').classList.remove('hidden');
};
document.getElementById('btn-cancel').onclick = () => document.getElementById('modal').classList.add('hidden');

</script>
</body>
</html>
